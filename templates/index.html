<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ö–æ–¥</title>
    <link rel="stylesheet" href="/static/index.css">
</head>
<body>
    <div class="container">
        <div class="form-wrapper">
            <h1>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h1>
            <button onclick="window.location.href='/history'" class="history-button">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
            <form action="/login" method="post" id="login-form">
                <div class="form-group">
                    <label for="username">–õ–æ–≥–∏–Ω:</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <div class="form-group">
                    <label for="claim_number">–ù–æ–º–µ—Ä –¥–µ–ª–∞:</label>
                    <input type="text" id="claim_number" name="claim_number">
                </div>
                <div class="form-group">
                    <label for="vin_number">VIN –Ω–æ–º–µ—Ä:</label>
                    <input type="text" id="vin_number" name="vin_number">
                </div>
                
                <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å–±–æ—Ä–∞ SVG -->
                <div class="form-group svg-toggle-group">
                    <label class="svg-toggle-label">
                        <span class="svg-toggle-text">–°–±–æ—Ä SVG —Ñ–∞–π–ª–æ–≤:</span>
                        <div class="svg-toggle-switch">
                            <input type="checkbox" id="svg_collection" name="svg_collection" value="on" checked>
                            <span class="svg-slider"></span>
                        </div>
                        <span class="svg-status-text" id="svg-status">–í–∫–ª—é—á–µ–Ω</span>
                    </label>
                </div>
                
                <button type="button" class="add-button" id="add-request-btn">–î–æ–±–∞–≤–∏—Ç—å</button>
                <button type="submit">–í–æ–π—Ç–∏</button>
                <button type="button" class="stop-button" id="stop-parser-btn">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä—Å–µ—Ä</button>
            </form>
            <div id="stop-parser-notification" class="notification hidden"></div>
        </div>
        
        <!-- –ü–∞–Ω–µ–ª—å —Å –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –∑–∞—è–≤–∫–∞–º–∏ -->
        <div class="requests-panel" id="requests-panel">
            <div class="panel-header">
                <h2>–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏</h2>
                <div class="drag-hint">üí° –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∑–∞—è–≤–∫–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞</div>
                <div class="stats-info">
                    <div class="stat-item">
                        <span class="stat-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–¥–Ω–æ–π –∑–∞—è–≤–∫–∏:</span>
                        <span class="stat-value" id="average-time">‚Äî</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫:</span>
                        <span class="stat-value" id="total-requests">0</span>
                    </div>
                </div>
            </div>
            <div class="requests-list" id="requests-list">
                <div class="empty-state">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫</div>
            </div>
            <div class="panel-footer">
                <div class="total-time">
                    <span class="total-label">–û–±—â–µ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:</span>
                    <span class="total-value" id="total-time">0–º 0—Å</span>
                </div>
            </div>
        </div>
    </div>
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let addedRequests = [];
        let processingStats = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async function() {
            await loadProcessingStats();
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        async function loadProcessingStats() {
            try {
                const response = await fetch('/api/processing-stats');
                const data = await response.json();
                processingStats = data;
                
                document.getElementById('average-time').textContent = data.average_time;
                updateTotalTime();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏
        document.getElementById('add-request-btn').addEventListener('click', function() {
            const claimNumber = document.getElementById('claim_number').value.trim();
            const vinNumber = document.getElementById('vin_number').value.trim();
            
            if (!claimNumber && !vinNumber) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–µ–ª–∞ –∏–ª–∏ VIN –Ω–æ–º–µ—Ä');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã
            const isDuplicate = addedRequests.some(request => 
                (request.claimNumber === (claimNumber || '–ù–µ –∑–∞–¥–∞–Ω–æ') && 
                 request.vinNumber === (vinNumber || '–ù–µ –∑–∞–¥–∞–Ω–æ')) ||
                (claimNumber && request.claimNumber === claimNumber) ||
                (vinNumber && request.vinNumber === vinNumber)
            );
            
            if (isDuplicate) {
                alert('–¢–∞–∫–∞—è –∑–∞—è–≤–∫–∞ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
                return;
            }
            
            const request = {
                id: Date.now(),
                claimNumber: claimNumber || '–ù–µ –∑–∞–¥–∞–Ω–æ',
                vinNumber: vinNumber || '–ù–µ –∑–∞–¥–∞–Ω–æ'
            };
            
            addedRequests.push(request);
            updateRequestsList();
            updateTotalTime();
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
            document.getElementById('claim_number').value = '';
            document.getElementById('vin_number').value = '';
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏
        function removeRequest(requestId) {
            addedRequests = addedRequests.filter(req => req.id !== requestId);
            updateRequestsList();
            updateTotalTime();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞—è–≤–æ–∫
        function updateRequestsList() {
            const requestsList = document.getElementById('requests-list');
            const totalRequests = document.getElementById('total-requests');
            
            totalRequests.textContent = addedRequests.length;
            
            if (addedRequests.length === 0) {
                requestsList.innerHTML = '<div class="empty-state">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫</div>';
                return;
            }
            
            requestsList.innerHTML = addedRequests.map((request, index) => `
                <div class="request-item" data-id="${request.id}" draggable="true">
                    <div class="request-number">${index + 1}</div>
                    <div class="request-info">
                        <div class="request-field">
                            <span class="field-label">–ù–æ–º–µ—Ä –¥–µ–ª–∞:</span>
                            <span class="field-value">${request.claimNumber}</span>
                        </div>
                        <div class="request-field">
                            <span class="field-label">VIN:</span>
                            <span class="field-value">${request.vinNumber}</span>
                        </div>
                    </div>
                    <button class="remove-btn" onclick="removeRequest(${request.id})" title="–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É">
                        <span class="remove-icon">√ó</span>
                    </button>
                </div>
            `).join('');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ drag & drop
            addDragAndDropHandlers();
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ drag & drop
        function addDragAndDropHandlers() {
            const requestItems = document.querySelectorAll('.request-item');
            
            requestItems.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('dragleave', handleDragLeave);
            });
        }
        
        // Drag & Drop –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let draggedItem = null;
        let draggedIndex = null;
        
        function handleDragStart(e) {
            draggedItem = this;
            draggedIndex = Array.from(this.parentNode.children).indexOf(this);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        
        function handleDragEnter(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        }
        
        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (draggedItem === this) return;
            
            const dropIndex = Array.from(this.parentNode.children).indexOf(this);
            
            // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤ –º–∞—Å—Å–∏–≤–µ
            const [movedItem] = addedRequests.splice(draggedIndex, 1);
            addedRequests.splice(dropIndex, 0, movedItem);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            updateRequestsList();
            updateTotalTime();
            
            // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            draggedItem.classList.remove('dragging');
            draggedItem = null;
            draggedIndex = null;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        function updateTotalTime() {
            if (!processingStats || addedRequests.length === 0) {
                document.getElementById('total-time').textContent = '0–º 0—Å';
                return;
            }
            
            // –ü–∞—Ä—Å–∏–º —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è
            const avgTimeMatch = processingStats.average_time.match(/(\d+)–º (\d+)—Å/);
            if (avgTimeMatch) {
                const avgMinutes = parseInt(avgTimeMatch[1]);
                const avgSeconds = parseInt(avgTimeMatch[2]);
                const avgTotalSeconds = avgMinutes * 60 + avgSeconds;
                
                const totalSeconds = avgTotalSeconds * addedRequests.length;
                const totalMinutes = Math.floor(totalSeconds / 60);
                const remainingSeconds = totalSeconds % 60;
                
                document.getElementById('total-time').textContent = `${totalMinutes}–º ${remainingSeconds}—Å`;
            }
        }

        document.getElementById('stop-parser-btn').addEventListener('click', async function() {
            const btn = this;
            btn.disabled = true;
            btn.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∫–∞...';

            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ POST –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ /terminate –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞—Ä—Å–µ—Ä–∞');

            try {
                const response = await fetch('/terminate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                console.log('–û—Ç–≤–µ—Ç –æ—Ç /terminate:', response);

                const data = await response.json();
                console.log('–î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', data);

                const notif = document.getElementById('stop-parser-notification');
                if (response.ok && data.status === 'success') {
                    notif.textContent = data.message || '–ü–∞—Ä—Å–µ—Ä —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.';
                    notif.className = 'notification success';
                } else {
                    notif.textContent = data.error || data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–∞—Ä—Å–µ—Ä–∞.';
                    notif.className = 'notification error';
                }
                notif.classList.remove('hidden');
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ /terminate:', e);
                const notif = document.getElementById('stop-parser-notification');
                notif.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.';
                notif.className = 'notification error';
                notif.classList.remove('hidden');
            }
            btn.disabled = false;
            btn.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä—Å–µ—Ä';
            window.open('/', '_self');
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è —Å–±–æ—Ä–∞ SVG
        document.getElementById('svg_collection').addEventListener('change', function() {
            const statusText = document.getElementById('svg-status');
            if (this.checked) {
                statusText.textContent = '–í–∫–ª—é—á–µ–Ω';
                statusText.classList.remove('disabled');
                statusText.classList.add('enabled');
            } else {
                statusText.textContent = '–û—Ç–∫–ª—é—á–µ–Ω';
                statusText.classList.remove('enabled');
                statusText.classList.add('disabled');
            }
        });
        

    </script>
</body>
</html>