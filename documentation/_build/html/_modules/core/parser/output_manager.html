

<!DOCTYPE html>
<html class="writer-html5" lang="ru" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>core.parser.output_manager &mdash; –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Audotex Parser 1.0</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=8b205fae" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=9ca2116e"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/translations.js?v=cd1d70c9"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="–ê–ª—Ñ–∞–≤–∏—Ç–Ω—ã–π —É–∫–∞–∑–∞—Ç–µ–ª—å" href="../../../genindex.html" />
    <link rel="search" title="–ü–æ–∏—Å–∫" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Audotex Parser
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="–ü–æ–∏—Å–∫ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏" aria-label="–ü–æ–∏—Å–∫ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="–ú–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏">
              <p class="caption" role="heading"><span class="caption-text">–ú–æ–¥—É–ª–∏:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/auth.html">–ú–æ–¥—É–ª—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (auth)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/database.html">–ú–æ–¥—É–ª—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (database)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/database.html#id3">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/database.html#er">ER-–¥–∏–∞–≥—Ä–∞–º–º–∞</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/parser.html">–ú–æ–¥—É–ª—å –ø–∞—Ä—Å–µ—Ä–∞ (parser)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/queue.html">–ú–æ–¥—É–ª—å –æ—á–µ—Ä–µ–¥–∏ (queue)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/security.html">–ú–æ–¥—É–ª—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (security)</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="–ú–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Audotex Parser</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">–ö–æ–¥ –º–æ–¥—É–ª—è</a></li>
      <li class="breadcrumb-item active">core.parser.output_manager</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ core.parser.output_manager</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏ –∏—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</span>

<span class="sd">–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:</span>
<span class="sd">    * create_zones_table: –§–æ—Ä–º–∏—Ä—É–µ—Ç HTML-—Ç–∞–±–ª–∏—Ü—É –∑–æ–Ω</span>
<span class="sd">    * save_data_to_json: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ JSON —Ñ–∞–π–ª</span>
<span class="sd">    * restore_started_at_from_db: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç started_at –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</span>
<span class="sd">    * restore_last_updated_from_db: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç last_updated –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</span>
<span class="sd">    * restore_completed_at_from_db: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç completed_at –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># –ú–æ–¥—É–ª—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytz</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">core.database.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ParserCarRequestStatus</span><span class="p">,</span> <span class="n">DatabaseSession</span><span class="p">,</span> <span class="n">get_moscow_time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">text</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># –§–æ—Ä–º–∏—Ä—É–µ—Ç HTML-—Ç–∞–±–ª–∏—Ü—É –∑–æ–Ω</span>
<div class="viewcode-block" id="create_zones_table">
<a class="viewcode-back" href="../../../modules/parser.html#core.parser.output_manager.create_zones_table">[–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_zones_table</span><span class="p">(</span><span class="n">zone_data</span><span class="p">):</span>
    <span class="n">table_html</span> <span class="o">=</span> <span class="s1">&#39;&lt;div class=&quot;zones-table&quot;&gt;&#39;</span>
    <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="n">zone_data</span><span class="p">:</span>
        <span class="n">table_html</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;&lt;div class=&quot;zone-row&quot;&gt;&lt;button class=&quot;zone-button&quot; data-zone-title=&quot;</span><span class="si">{</span><span class="n">zone</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot;&gt;</span><span class="si">{</span><span class="n">zone</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">zone</span><span class="p">[</span><span class="s2">&quot;has_pictograms&quot;</span><span class="p">]:</span>
            <span class="n">table_html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;span class=&quot;pictogram-icon&quot;&gt;üñºÔ∏è&lt;/span&gt;&#39;</span>
        <span class="n">table_html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/button&gt;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">zone</span><span class="p">[</span><span class="s2">&quot;graphics_not_available&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">zone</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;svg_path&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">zone</span><span class="p">[</span><span class="s2">&quot;svg_path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">table_html</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;&lt;a href=&quot;</span><span class="si">{</span><span class="n">zone</span><span class="p">[</span><span class="s2">&quot;svg_path&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot; download class=&quot;svg-download&quot; title=&quot;–°–∫–∞—á–∞—Ç—å SVG&quot;&gt;&lt;span class=&quot;download-icon&quot;&gt;‚¨á&lt;/span&gt;&lt;/a&gt;&#39;</span>
        <span class="n">table_html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/div&gt;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">zone_data</span><span class="p">:</span>
        <span class="n">table_html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;p&gt;–ó–æ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã&lt;/p&gt;&#39;</span>
    <span class="n">table_html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/div&gt;&#39;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;HTML-—Ç–∞–±–ª–∏—Ü–∞ –∑–æ–Ω —Å–æ–∑–¥–∞–Ω–∞&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">table_html</span></div>



<span class="c1"># –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ JSON</span>
<div class="viewcode-block" id="save_data_to_json">
<a class="viewcode-back" href="../../../modules/parser.html#core.parser.output_manager.save_data_to_json">[–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">save_data_to_json</span><span class="p">(</span><span class="n">vin_value</span><span class="p">,</span> <span class="n">zone_data</span><span class="p">,</span> <span class="n">main_screenshot_path</span><span class="p">,</span> <span class="n">main_svg_path</span><span class="p">,</span> <span class="n">zones_table</span><span class="p">,</span> <span class="n">all_svgs_zip</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">claim_number</span><span class="p">,</span> <span class="n">options_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vin_status</span><span class="o">=</span><span class="s2">&quot;–ù–µ—Ç&quot;</span><span class="p">,</span> <span class="n">started_at</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">completed_at</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_intermediate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–∞–ø–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå –ü–∞–ø–∫–∞ </span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s2"> –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ—ë&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ –ü–∞–ø–∫–∞ </span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s2"> —Å–æ–∑–¥–∞–Ω–∞&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É </span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    
    <span class="c1"># –î–ª—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞</span>
    <span class="k">if</span> <span class="n">is_intermediate</span><span class="p">:</span>
        <span class="n">json_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;data_intermediate_</span><span class="si">{</span><span class="n">claim_number</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π JSON –≤: </span><span class="si">{</span><span class="n">json_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># –î–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º timestamp</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
        <span class="n">json_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;data_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π JSON –≤: </span><span class="si">{</span><span class="n">json_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</span>
    <span class="n">json_completed</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># JSON –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–±—Ä–∞–Ω</span>
    <span class="n">db_saved</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –ë–î —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ</span>
    
    <span class="c1"># –°–æ–∑–¥–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —É—á–µ—Ç–æ–º —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_time_with_timezone</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –≤—Ä–µ–º—è —Å —É—á–µ—Ç–æ–º —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –¥–ª—è JSON&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="c1"># –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üîç format_time_with_timezone –ø–æ–ª—É—á–∏–ª: </span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2"> (—Ç–∏–ø: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        
        <span class="c1"># –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–∞ —Å—Ç—Ä–æ–∫–∞, –ø—ã—Ç–∞–µ–º—Å—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ datetime</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;+00:00&#39;</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ –°—Ç—Ä–æ–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∞: </span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É –≤—Ä–µ–º–µ–Ω–∏ &#39;</span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        
        <span class="c1"># –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –æ–±—ä–µ–∫—Ç datetime</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ö†Ô∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ç–∏–ø –≤—Ä–µ–º–µ–Ω–∏: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="si">}</span><span class="s2">, –∑–Ω–∞—á–µ–Ω–∏–µ: </span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># –ï—Å–ª–∏ –≤—Ä–µ–º—è –±–µ–∑ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞, —Å—á–∏—Ç–∞–µ–º –µ–≥–æ –º–æ—Å–∫–æ–≤—Å–∫–∏–º</span>
            <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">moscow_tz</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;Europe/Moscow&#39;</span><span class="p">)</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">moscow_tz</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span><span class="o">.</span><span class="n">utcoffset</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># –ï—Å–ª–∏ –≤—Ä–µ–º—è –≤ UTC, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–µ</span>
                <span class="n">moscow_tz</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;Europe/Moscow&#39;</span><span class="p">)</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">moscow_tz</span><span class="p">)</span>
            
            <span class="c1"># –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º –≤—Ä–µ–º–µ–Ω–∏</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ –í—Ä–µ–º—è –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–æ: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ </span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;started_at&quot;</span><span class="p">:</span> <span class="n">format_time_with_timezone</span><span class="p">(</span><span class="n">started_at</span><span class="p">),</span>
        <span class="s2">&quot;completed_at&quot;</span><span class="p">:</span> <span class="n">format_time_with_timezone</span><span class="p">(</span><span class="n">completed_at</span><span class="p">),</span>
        <span class="s2">&quot;last_updated&quot;</span><span class="p">:</span> <span class="n">format_time_with_timezone</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()),</span>
        <span class="s2">&quot;json_completed&quot;</span><span class="p">:</span> <span class="n">json_completed</span><span class="p">,</span>
        <span class="s2">&quot;db_saved&quot;</span><span class="p">:</span> <span class="n">db_saved</span><span class="p">,</span>
        <span class="s2">&quot;total_zones&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">zone_data</span><span class="p">),</span>
        <span class="s2">&quot;total_options&quot;</span><span class="p">:</span> <span class="n">options_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;statistics&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_options&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">options_data</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;options_success&quot;</span><span class="p">:</span> <span class="n">options_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">if</span> <span class="n">options_data</span> <span class="k">else</span> <span class="kc">False</span>
    <span class="p">}</span>
    
    <span class="c1"># –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—É—Ç–µ–π –ø–æ–¥ —Ç–µ–∫—É—â—É—é –û–°</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">normalize_path</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;vin_value&quot;</span><span class="p">:</span> <span class="n">vin_value</span><span class="p">,</span>
        <span class="s2">&quot;vin_status&quot;</span><span class="p">:</span> <span class="n">vin_status</span><span class="p">,</span>
        <span class="s2">&quot;zone_data&quot;</span><span class="p">:</span> <span class="p">[{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">zone</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">],</span>
            <span class="s2">&quot;screenshot_path&quot;</span><span class="p">:</span> <span class="n">normalize_path</span><span class="p">(</span><span class="n">zone</span><span class="p">[</span><span class="s2">&quot;screenshot_path&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;svg_path&quot;</span><span class="p">:</span> <span class="n">normalize_path</span><span class="p">(</span><span class="n">zone</span><span class="p">[</span><span class="s2">&quot;svg_path&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">zone</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;svg_path&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;has_pictograms&quot;</span><span class="p">:</span> <span class="n">zone</span><span class="p">[</span><span class="s2">&quot;has_pictograms&quot;</span><span class="p">],</span>
            <span class="s2">&quot;graphics_not_available&quot;</span><span class="p">:</span> <span class="n">zone</span><span class="p">[</span><span class="s2">&quot;graphics_not_available&quot;</span><span class="p">],</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">detail</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">],</span> <span class="s2">&quot;svg_path&quot;</span><span class="p">:</span> <span class="n">normalize_path</span><span class="p">(</span><span class="n">detail</span><span class="p">[</span><span class="s2">&quot;svg_path&quot;</span><span class="p">])}</span> <span class="k">for</span> <span class="n">detail</span> <span class="ow">in</span> <span class="n">zone</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">]],</span>
            <span class="s2">&quot;pictograms&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;section_name&quot;</span><span class="p">:</span> <span class="n">pictogram</span><span class="p">[</span><span class="s2">&quot;section_name&quot;</span><span class="p">],</span> <span class="s2">&quot;works&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;work_name1&quot;</span><span class="p">:</span> <span class="n">work</span><span class="p">[</span><span class="s2">&quot;work_name1&quot;</span><span class="p">],</span> <span class="s2">&quot;work_name2&quot;</span><span class="p">:</span> <span class="n">work</span><span class="p">[</span><span class="s2">&quot;work_name2&quot;</span><span class="p">],</span> <span class="s2">&quot;svg_path&quot;</span><span class="p">:</span> <span class="n">normalize_path</span><span class="p">(</span><span class="n">work</span><span class="p">[</span><span class="s2">&quot;svg_path&quot;</span><span class="p">])}</span> <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="n">pictogram</span><span class="p">[</span><span class="s2">&quot;works&quot;</span><span class="p">]]}</span> <span class="k">for</span> <span class="n">pictogram</span> <span class="ow">in</span> <span class="n">zone</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pictograms&quot;</span><span class="p">,</span> <span class="p">[])]</span>
        <span class="p">}</span> <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="n">zone_data</span><span class="p">],</span>
        <span class="s2">&quot;main_screenshot_path&quot;</span><span class="p">:</span> <span class="n">normalize_path</span><span class="p">(</span><span class="n">main_screenshot_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">main_screenshot_path</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;main_svg_path&quot;</span><span class="p">:</span> <span class="n">normalize_path</span><span class="p">(</span><span class="n">main_svg_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">main_svg_path</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;zones_table&quot;</span><span class="p">:</span> <span class="n">zones_table</span><span class="p">,</span>
        <span class="s2">&quot;all_svgs_zip&quot;</span><span class="p">:</span> <span class="n">normalize_path</span><span class="p">(</span><span class="n">all_svgs_zip</span><span class="p">)</span> <span class="k">if</span> <span class="n">all_svgs_zip</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;options_data&quot;</span><span class="p">:</span> <span class="n">options_data</span> <span class="k">if</span> <span class="n">options_data</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;zones&quot;</span><span class="p">:</span> <span class="p">[]},</span>
        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">,</span>
        <span class="s2">&quot;claim_number&quot;</span><span class="p">:</span> <span class="n">claim_number</span>
    <span class="p">}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ </span><span class="si">{</span><span class="n">json_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üìä VIN —Å—Ç–∞—Ç—É—Å &#39;</span><span class="si">{</span><span class="n">vin_status</span><span class="si">}</span><span class="s2">&#39; —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ JSON&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚è±Ô∏è –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞: </span><span class="si">{</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;started_at&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: </span><span class="si">{</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;completed_at&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># –õ–æ–≥–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤–æ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –ø–∞—Ä—Å–µ—Ä–∞</span>
    <span class="k">if</span> <span class="n">started_at</span> <span class="ow">and</span> <span class="n">completed_at</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># –ü—Ä–∏–≤–æ–¥–∏–º –æ–±–∞ –≤—Ä–µ–º–µ–Ω–∏ –∫ timezone-aware —Ñ–æ—Ä–º–∞—Ç—É</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">ensure_timezone_aware</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># –ï—Å–ª–∏ naive, —Å—á–∏—Ç–∞–µ–º –º–æ—Å–∫–æ–≤—Å–∫–∏–º –≤—Ä–µ–º–µ–Ω–µ–º</span>
                    <span class="n">moscow_tz</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;Europe/Moscow&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">moscow_tz</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">dt</span>
            
            <span class="n">aware_started</span> <span class="o">=</span> <span class="n">ensure_timezone_aware</span><span class="p">(</span><span class="n">started_at</span><span class="p">)</span>
            <span class="n">aware_completed</span> <span class="o">=</span> <span class="n">ensure_timezone_aware</span><span class="p">(</span><span class="n">completed_at</span><span class="p">)</span>
            
            <span class="n">duration_seconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">aware_completed</span> <span class="o">-</span> <span class="n">aware_started</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
            <span class="n">duration_minutes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">duration_seconds</span> <span class="o">//</span> <span class="mi">60</span><span class="p">)</span>
            <span class="n">duration_secs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">duration_seconds</span> <span class="o">%</span> <span class="mi">60</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚è±Ô∏è –ò—Ç–æ–≥–æ–≤–æ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –ø–∞—Ä—Å–µ—Ä–∞: </span><span class="si">{</span><span class="n">duration_minutes</span><span class="si">}</span><span class="s2">–º </span><span class="si">{</span><span class="n">duration_secs</span><span class="si">}</span><span class="s2">—Å&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –∏—Ç–æ–≥–æ–≤–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üèÅ JSON –∑–∞–≤–µ—Ä—à–µ–Ω: </span><span class="si">{</span><span class="n">json_completed</span><span class="si">}</span><span class="s2">, –ë–î —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: </span><span class="si">{</span><span class="n">db_saved</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options_data</span> <span class="ow">and</span> <span class="n">options_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">):</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">options_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;statistics&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üíæ –û–ø—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã: </span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_selected&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_options&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> –≤ </span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_zones&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> –∑–æ–Ω–∞—Ö&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json_path</span></div>



<div class="viewcode-block" id="restore_started_at_from_db">
<a class="viewcode-back" href="../../../modules/parser.html#core.parser.output_manager.restore_started_at_from_db">[–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">restore_started_at_from_db</span><span class="p">(</span><span class="n">json_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">claim_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vin_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç started_at –∏–∑ –ë–î –µ—Å–ª–∏ –≤ JSON –æ–Ω null</span>
<span class="sd">    –£—á–∏—Ç—ã–≤–∞–µ—Ç —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å: –ë–î —Ö—Ä–∞–Ω–∏—Ç –≤ UTC+3, JSON –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># –ß–∏—Ç–∞–µ–º JSON —Ñ–∞–π–ª</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
        <span class="c1"># –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ started_at –∏ —Ä–∞–≤–µ–Ω –ª–∏ –æ–Ω null</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">started_at</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;started_at&#39;</span><span class="p">)</span>
        
        <span class="c1"># –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</span>
        <span class="n">should_restore</span> <span class="o">=</span> <span class="p">(</span><span class="n">started_at</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">started_at</span> <span class="o">==</span> <span class="s2">&quot;null&quot;</span> <span class="ow">or</span> <span class="n">started_at</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span> <span class="ow">or</span> <span class="n">started_at</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        
        <span class="c1"># –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ started_at null –∏–ª–∏ –ø—É—Å—Ç–æ–π</span>
        <span class="c1"># –ï—Å–ª–∏ started_at –µ—Å—Ç—å, –Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π - –Ω–µ —Ç—Ä–æ–≥–∞–µ–º –µ–≥–æ</span>
        
        <span class="k">if</span> <span class="n">should_restore</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üîç –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º started_at –∏–∑ –ë–î –¥–ª—è </span><span class="si">{</span><span class="n">claim_number</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">vin_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># –ò—â–µ–º –≤ –ë–î</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">DatabaseSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    SELECT started_at </span>
<span class="s2">                    FROM parser_car_request_status </span>
<span class="s2">                    WHERE request_id = &#39;</span><span class="si">{</span><span class="n">claim_number</span><span class="si">}</span><span class="s2">&#39; AND vin = &#39;</span><span class="si">{</span><span class="n">vin_number</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">                    ORDER BY created_date DESC, id DESC </span>
<span class="s2">                    LIMIT 1</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">db_started_at</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
                
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üîç –ü–æ–ª—É—á–µ–Ω–æ –∏–∑ –ë–î –¥–ª—è </span><span class="si">{</span><span class="n">claim_number</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">vin_number</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">db_started_at</span><span class="si">}</span><span class="s2"> (—Ç–∏–ø: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">db_started_at</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">db_started_at</span><span class="p">:</span>
                    <span class="c1"># –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">db_started_at</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="c1"># –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞, –ø–∞—Ä—Å–∏–º –µ—ë</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># –ü—Ä–æ–±—É–µ–º –ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ ISO —Ñ–æ—Ä–º–∞—Ç —Å —á–∞—Å–æ–≤—ã–º –ø–æ—è—Å–æ–º</span>
                            <span class="n">db_started_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">db_started_at</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="c1"># –ü—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">db_started_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">db_started_at</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –≤—Ä–µ–º—è –∏–∑ –ë–î: </span><span class="si">{</span><span class="n">db_started_at</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="k">return</span> <span class="kc">False</span>
                    
                    <span class="c1"># –í –ë–î –≤—Ä–µ–º—è —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ UTC+3 (–º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è)</span>
                    <span class="c1"># –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è –¥–ª—è JSON</span>
                    <span class="k">if</span> <span class="n">db_started_at</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># –ï—Å–ª–∏ –≤—Ä–µ–º—è –±–µ–∑ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞, —Å—á–∏—Ç–∞–µ–º –µ–≥–æ –º–æ—Å–∫–æ–≤—Å–∫–∏–º</span>
                        <span class="n">moscow_tz</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;Europe/Moscow&#39;</span><span class="p">)</span>
                        <span class="n">db_started_at</span> <span class="o">=</span> <span class="n">moscow_tz</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">db_started_at</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">db_started_at</span><span class="o">.</span><span class="n">tzinfo</span><span class="o">.</span><span class="n">utcoffset</span><span class="p">(</span><span class="n">db_started_at</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># –ï—Å–ª–∏ –≤—Ä–µ–º—è –≤ UTC, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–µ</span>
                        <span class="n">moscow_tz</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;Europe/Moscow&#39;</span><span class="p">)</span>
                        <span class="n">db_started_at</span> <span class="o">=</span> <span class="n">db_started_at</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">moscow_tz</span><span class="p">)</span>
                    <span class="c1"># –ï—Å–ª–∏ –≤—Ä–µ–º—è —É–∂–µ –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ (+03), –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å</span>
                    
                    <span class="c1"># –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –¥–ª—è JSON</span>
                    <span class="n">formatted_time</span> <span class="o">=</span> <span class="n">db_started_at</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
                    
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è </span><span class="si">{</span><span class="n">claim_number</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">vin_number</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  –ò—Å—Ö–æ–¥–Ω–æ–µ –∏–∑ –ë–î: </span><span class="si">{</span><span class="n">db_started_at</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: </span><span class="si">{</span><span class="n">db_started_at</span><span class="o">.</span><span class="n">tzinfo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  –ò—Ç–æ–≥–æ–≤–æ–µ –¥–ª—è JSON: </span><span class="si">{</span><span class="n">formatted_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># –û–±–Ω–æ–≤–ª—è–µ–º JSON</span>
                    <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;started_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formatted_time</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
                    
                    <span class="c1"># –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π JSON</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ started_at –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ –ë–î: </span><span class="si">{</span><span class="n">formatted_time</span><span class="si">}</span><span class="s2"> (–ú–°–ö)&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ö†Ô∏è started_at –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î –¥–ª—è </span><span class="si">{</span><span class="n">claim_number</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">vin_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ started_at —É–∂–µ –µ—Å—Ç—å –≤ JSON: </span><span class="si">{</span><span class="n">started_at</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
            
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è started_at: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="restore_last_updated_from_db">
<a class="viewcode-back" href="../../../modules/parser.html#core.parser.output_manager.restore_last_updated_from_db">[–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">restore_last_updated_from_db</span><span class="p">(</span><span class="n">json_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">claim_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vin_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç last_updated –∏–∑ –ë–î –µ—Å–ª–∏ –≤ JSON –æ–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π</span>
<span class="sd">    –£—á–∏—Ç—ã–≤–∞–µ—Ç —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å: –ë–î —Ö—Ä–∞–Ω–∏—Ç –≤ UTC+3, JSON –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># –ß–∏—Ç–∞–µ–º JSON —Ñ–∞–π–ª</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
        <span class="c1"># –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ last_updated –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–∏ –æ–Ω</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">last_updated</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_updated&#39;</span><span class="p">)</span>
        
        <span class="c1"># –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</span>
        <span class="n">should_restore</span> <span class="o">=</span> <span class="p">(</span><span class="n">last_updated</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">last_updated</span> <span class="o">==</span> <span class="s2">&quot;null&quot;</span> <span class="ow">or</span> <span class="n">last_updated</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span> <span class="ow">or</span> <span class="n">last_updated</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        
        <span class="c1"># –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ last_updated null –∏–ª–∏ –ø—É—Å—Ç–æ–π</span>
        <span class="c1"># –ï—Å–ª–∏ last_updated –µ—Å—Ç—å, –Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π - –Ω–µ —Ç—Ä–æ–≥–∞–µ–º –µ–≥–æ</span>
        
        <span class="k">if</span> <span class="n">should_restore</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üîç –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º last_updated –∏–∑ –ë–î –¥–ª—è </span><span class="si">{</span><span class="n">claim_number</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">vin_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># –ò—â–µ–º –≤ –ë–î</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">DatabaseSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    SELECT completed_at </span>
<span class="s2">                    FROM parser_car_request_status </span>
<span class="s2">                    WHERE request_id = &#39;</span><span class="si">{</span><span class="n">claim_number</span><span class="si">}</span><span class="s2">&#39; AND vin = &#39;</span><span class="si">{</span><span class="n">vin_number</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">                    ORDER BY created_date DESC, id DESC </span>
<span class="s2">                    LIMIT 1</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">db_completed_at</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
                
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üîç –ü–æ–ª—É—á–µ–Ω–æ completed_at –∏–∑ –ë–î –¥–ª—è </span><span class="si">{</span><span class="n">claim_number</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">vin_number</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">db_completed_at</span><span class="si">}</span><span class="s2"> (—Ç–∏–ø: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">db_completed_at</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">db_completed_at</span><span class="p">:</span>
                    <span class="c1"># –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">db_completed_at</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="c1"># –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞, –ø–∞—Ä—Å–∏–º –µ—ë</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># –ü—Ä–æ–±—É–µ–º –ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ ISO —Ñ–æ—Ä–º–∞—Ç —Å —á–∞—Å–æ–≤—ã–º –ø–æ—è—Å–æ–º</span>
                            <span class="n">db_completed_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">db_completed_at</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="c1"># –ü—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">db_completed_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">db_completed_at</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –≤—Ä–µ–º—è –∏–∑ –ë–î: </span><span class="si">{</span><span class="n">db_completed_at</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="k">return</span> <span class="kc">False</span>
                    
                    <span class="c1"># –í –ë–î –≤—Ä–µ–º—è —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ UTC+3 (–º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è)</span>
                    <span class="c1"># –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è –¥–ª—è JSON</span>
                    <span class="k">if</span> <span class="n">db_completed_at</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># –ï—Å–ª–∏ –≤—Ä–µ–º—è –±–µ–∑ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞, —Å—á–∏—Ç–∞–µ–º –µ–≥–æ –º–æ—Å–∫–æ–≤—Å–∫–∏–º</span>
                        <span class="n">moscow_tz</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;Europe/Moscow&#39;</span><span class="p">)</span>
                        <span class="n">db_completed_at</span> <span class="o">=</span> <span class="n">moscow_tz</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">db_completed_at</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">db_completed_at</span><span class="o">.</span><span class="n">tzinfo</span><span class="o">.</span><span class="n">utcoffset</span><span class="p">(</span><span class="n">db_completed_at</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># –ï—Å–ª–∏ –≤—Ä–µ–º—è –≤ UTC, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–µ</span>
                        <span class="n">moscow_tz</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;Europe/Moscow&#39;</span><span class="p">)</span>
                        <span class="n">db_completed_at</span> <span class="o">=</span> <span class="n">db_completed_at</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">moscow_tz</span><span class="p">)</span>
                    <span class="c1"># –ï—Å–ª–∏ –≤—Ä–µ–º—è —É–∂–µ –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ (+03), –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å</span>
                    
                    <span class="c1"># –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –¥–ª—è JSON</span>
                    <span class="n">formatted_time</span> <span class="o">=</span> <span class="n">db_completed_at</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
                    
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ last_updated –¥–ª—è </span><span class="si">{</span><span class="n">claim_number</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">vin_number</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  –ò—Å—Ö–æ–¥–Ω–æ–µ –∏–∑ –ë–î: </span><span class="si">{</span><span class="n">db_completed_at</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: </span><span class="si">{</span><span class="n">db_completed_at</span><span class="o">.</span><span class="n">tzinfo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  –ò—Ç–æ–≥–æ–≤–æ–µ –¥–ª—è JSON: </span><span class="si">{</span><span class="n">formatted_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># –û–±–Ω–æ–≤–ª—è–µ–º JSON</span>
                    <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;last_updated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formatted_time</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
                    
                    <span class="c1"># –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π JSON</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ last_updated –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ –ë–î: </span><span class="si">{</span><span class="n">formatted_time</span><span class="si">}</span><span class="s2"> (–ú–°–ö)&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ö†Ô∏è completed_at –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î –¥–ª—è </span><span class="si">{</span><span class="n">claim_number</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">vin_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ last_updated —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤ JSON: </span><span class="si">{</span><span class="n">last_updated</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
            
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è last_updated: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="restore_completed_at_from_db">
<a class="viewcode-back" href="../../../modules/parser.html#core.parser.output_manager.restore_completed_at_from_db">[–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">restore_completed_at_from_db</span><span class="p">(</span><span class="n">json_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">claim_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vin_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">force_restore</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç completed_at –∏–∑ –ë–î –µ—Å–ª–∏ –≤ JSON –æ–Ω null –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π</span>
<span class="sd">    –£—á–∏—Ç—ã–≤–∞–µ—Ç —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å: –ë–î —Ö—Ä–∞–Ω–∏—Ç –≤ UTC+3, JSON –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        json_path: –ü—É—Ç—å –∫ JSON —Ñ–∞–π–ª—É</span>
<span class="sd">        claim_number: –ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏</span>
<span class="sd">        vin_number: VIN –Ω–æ–º–µ—Ä</span>
<span class="sd">        force_restore: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –ë–î</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># –ß–∏—Ç–∞–µ–º JSON —Ñ–∞–π–ª</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
        <span class="c1"># –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ completed_at –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–∏ –æ–Ω</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">completed_at</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;completed_at&#39;</span><span class="p">)</span>
        
        <span class="c1"># –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</span>
        <span class="n">should_restore</span> <span class="o">=</span> <span class="p">(</span><span class="n">completed_at</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">completed_at</span> <span class="o">==</span> <span class="s2">&quot;null&quot;</span> <span class="ow">or</span> <span class="n">completed_at</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span> <span class="ow">or</span> <span class="n">completed_at</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        
        <span class="c1"># –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–∏, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">should_restore</span> <span class="ow">and</span> <span class="n">completed_at</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># –ü–∞—Ä—Å–∏–º –≤—Ä–µ–º—è –∏–∑ JSON</span>
                <span class="n">json_completed_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">completed_at</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
                <span class="c1"># –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Ä–µ–º—è –Ω–µ —Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä–æ–µ (–ø—Ä–∏–∑–Ω–∞–∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏)</span>
                <span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="n">time_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="n">json_completed_dt</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">time_diff</span> <span class="o">&gt;</span> <span class="mi">86400</span><span class="p">:</span>  <span class="c1"># –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –±–æ–ª—å—à–µ 24 —á–∞—Å–æ–≤</span>
                    <span class="n">should_restore</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üîç completed_at –≤ JSON —Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä–æ–µ –¥–ª—è </span><span class="si">{</span><span class="n">claim_number</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">vin_number</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">completed_at</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">should_restore</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1"># –ï—Å–ª–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, —Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ</span>
        <span class="k">if</span> <span class="n">force_restore</span><span class="p">:</span>
            <span class="n">should_restore</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üîç –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ completed_at –¥–ª—è </span><span class="si">{</span><span class="n">claim_number</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">vin_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">should_restore</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üîç –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º completed_at –∏–∑ –ë–î –¥–ª—è </span><span class="si">{</span><span class="n">claim_number</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">vin_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># –ò—â–µ–º –≤ –ë–î</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">DatabaseSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    SELECT completed_at </span>
<span class="s2">                    FROM parser_car_request_status </span>
<span class="s2">                    WHERE request_id = &#39;</span><span class="si">{</span><span class="n">claim_number</span><span class="si">}</span><span class="s2">&#39; AND vin = &#39;</span><span class="si">{</span><span class="n">vin_number</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">                    ORDER BY created_date DESC, id DESC </span>
<span class="s2">                    LIMIT 1</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">db_completed_at</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
                
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üîç –ü–æ–ª—É—á–µ–Ω–æ completed_at –∏–∑ –ë–î –¥–ª—è </span><span class="si">{</span><span class="n">claim_number</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">vin_number</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">db_completed_at</span><span class="si">}</span><span class="s2"> (—Ç–∏–ø: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">db_completed_at</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">db_completed_at</span><span class="p">:</span>
                    <span class="c1"># –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">db_completed_at</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="c1"># –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞, –ø–∞—Ä—Å–∏–º –µ—ë</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># –ü—Ä–æ–±—É–µ–º –ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ ISO —Ñ–æ—Ä–º–∞—Ç —Å —á–∞—Å–æ–≤—ã–º –ø–æ—è—Å–æ–º</span>
                            <span class="n">db_completed_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">db_completed_at</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="c1"># –ü—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">db_completed_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">db_completed_at</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –≤—Ä–µ–º—è –∏–∑ –ë–î: </span><span class="si">{</span><span class="n">db_completed_at</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="k">return</span> <span class="kc">False</span>
                    
                    <span class="c1"># –í –ë–î –≤—Ä–µ–º—è —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ UTC+3 (–º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è)</span>
                    <span class="c1"># –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è –¥–ª—è JSON</span>
                    <span class="k">if</span> <span class="n">db_completed_at</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># –ï—Å–ª–∏ –≤—Ä–µ–º—è –±–µ–∑ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞, —Å—á–∏—Ç–∞–µ–º –µ–≥–æ –º–æ—Å–∫–æ–≤—Å–∫–∏–º</span>
                        <span class="n">moscow_tz</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;Europe/Moscow&#39;</span><span class="p">)</span>
                        <span class="n">db_completed_at</span> <span class="o">=</span> <span class="n">moscow_tz</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">db_completed_at</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">db_completed_at</span><span class="o">.</span><span class="n">tzinfo</span><span class="o">.</span><span class="n">utcoffset</span><span class="p">(</span><span class="n">db_completed_at</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># –ï—Å–ª–∏ –≤—Ä–µ–º—è –≤ UTC, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–µ</span>
                        <span class="n">moscow_tz</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;Europe/Moscow&#39;</span><span class="p">)</span>
                        <span class="n">db_completed_at</span> <span class="o">=</span> <span class="n">db_completed_at</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">moscow_tz</span><span class="p">)</span>
                    <span class="c1"># –ï—Å–ª–∏ –≤—Ä–µ–º—è —É–∂–µ –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ (+03), –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å</span>
                    
                    <span class="c1"># –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –¥–ª—è JSON</span>
                    <span class="n">formatted_time</span> <span class="o">=</span> <span class="n">db_completed_at</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
                    
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ completed_at –¥–ª—è </span><span class="si">{</span><span class="n">claim_number</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">vin_number</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  –ò—Å—Ö–æ–¥–Ω–æ–µ –∏–∑ –ë–î: </span><span class="si">{</span><span class="n">db_completed_at</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: </span><span class="si">{</span><span class="n">db_completed_at</span><span class="o">.</span><span class="n">tzinfo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  –ò—Ç–æ–≥–æ–≤–æ–µ –¥–ª—è JSON: </span><span class="si">{</span><span class="n">formatted_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># –û–±–Ω–æ–≤–ª—è–µ–º JSON</span>
                    <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;completed_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formatted_time</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
                    
                    <span class="c1"># –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π JSON</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ completed_at –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ –ë–î: </span><span class="si">{</span><span class="n">formatted_time</span><span class="si">}</span><span class="s2"> (–ú–°–ö)&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ö†Ô∏è completed_at –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î –¥–ª—è </span><span class="si">{</span><span class="n">claim_number</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">vin_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ completed_at —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤ JSON: </span><span class="si">{</span><span class="n">completed_at</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
            
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è completed_at: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span> </div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; –ê–≤—Ç–æ—Ä—Å–∫–∏–µ –ø—Ä–∞–≤–∞ 2024. </p>
  </div>

  –°–æ–±—Ä–∞–Ω–æ –ø—Ä–∏ –ø–æ–º–æ—â–∏ <a href="https://www.sphinx-doc.org/">Sphinx</a> —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">—Ç–µ–º—ã,</a>
    –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>