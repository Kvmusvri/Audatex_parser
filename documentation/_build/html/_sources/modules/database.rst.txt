Модуль базы данных (database)
=============================

Обзор
-----

Модуль базы данных обеспечивает работу с PostgreSQL базой данных через SQLAlchemy ORM.

Основные компоненты:

* **models.py** - SQLAlchemy модели данных
* **requests.py** - Функции для работы с данными парсера
* **init_db.py** - Инициализация и настройка базы данных

Модули
-------

core.database.models
--------------------

SQLAlchemy модели для всех таблиц базы данных.

.. automodule:: core.database.models
   :members:
   :undoc-members:
   :show-inheritance:

core.database.requests
----------------------

Функции для сохранения и получения данных парсера из базы данных.

.. automodule:: core.database.requests
   :members:
   :undoc-members:

core.database.init_db
---------------------

Инициализация базы данных и создание таблиц.

.. automodule:: core.database.init_db
   :members:
   :undoc-members:

Структура базы данных
====================

parser_car_detail
----------------

Детали автомобиля

+-------------+-------------+----------+-------------+-------------+--------+
| Поле        | Тип         | Nullable | Primary Key | Foreign Key | Индекс |
+=============+=============+==========+=============+=============+========+
| id          | INTEGER     | ✗        | ✓           |             |        |
+-------------+-------------+----------+-------------+-------------+--------+
| request_id  | VARCHAR(50) | ✗        |             |             | ✓      |
+-------------+-------------+----------+-------------+-------------+--------+
| vin         | VARCHAR(50) | ✗        |             |             | ✓      |
+-------------+-------------+----------+-------------+-------------+--------+
| group_zone  | VARCHAR(50) | ✗        |             |             |        |
+-------------+-------------+----------+-------------+-------------+--------+
| code        | VARCHAR(50) | ✗        |             |             |        |
+-------------+-------------+----------+-------------+-------------+--------+
| title       | TEXT        | ✗        |             |             |        |
+-------------+-------------+----------+-------------+-------------+--------+
| source_from | VARCHAR(50) | ✗        |             |             |        |
+-------------+-------------+----------+-------------+-------------+--------+
| created_date| DATE        | ✗        |             |             |        |
+-------------+-------------+----------+-------------+-------------+--------+

parser_car_detail_group_zone
----------------------------

Группы зон деталей

+-------------+-------------+----------+-------------+-------------+--------+
| Поле        | Тип         | Nullable | Primary Key | Foreign Key | Индекс |
+=============+=============+==========+=============+=============+========+
| id          | INTEGER     | ✗        | ✓           |             |        |
+-------------+-------------+----------+-------------+-------------+--------+
| request_id  | VARCHAR(50) | ✗        |             |             | ✓      |
+-------------+-------------+----------+-------------+-------------+--------+
| vin         | VARCHAR(50) | ✗        |             |             | ✓      |
+-------------+-------------+----------+-------------+-------------+--------+
| type        | VARCHAR(50) | ✗        |             |             |        |
+-------------+-------------+----------+-------------+-------------+--------+
| title       | TEXT        | ✗        |             |             |        |
+-------------+-------------+----------+-------------+-------------+--------+
| source_from | VARCHAR(50) | ✗        |             |             |        |
+-------------+-------------+----------+-------------+-------------+--------+
| created_date| DATE        | ✗        |             |             |        |
+-------------+-------------+----------+-------------+-------------+--------+

parser_car_request_status
-------------------------

Статус обработки заявок

+----------------+-------------+----------+-------------+-------------+--------+
| Поле           | Тип         | Nullable | Primary Key | Foreign Key | Индекс |
+================+=============+==========+=============+=============+========+
| id             | INTEGER     | ✗        | ✓           |             |        |
+----------------+-------------+----------+-------------+-------------+--------+
| request_id     | VARCHAR(50) | ✗        |             |             | ✓      |
+----------------+-------------+----------+-------------+-------------+--------+
| vin            | VARCHAR(50) | ✗        |             |             | ✓      |
+----------------+-------------+----------+-------------+-------------+--------+
| vin_status     | VARCHAR(50) | ✗        |             |             |        |
+----------------+-------------+----------+-------------+-------------+--------+
| comment        | VARCHAR(50) | ✗        |             |             |        |
+----------------+-------------+----------+-------------+-------------+--------+
| started_at     | DATETIME    | ✓        |             |             |        |
+----------------+-------------+----------+-------------+-------------+--------+
| completed_at   | DATETIME    | ✓        |             |             |        |
+----------------+-------------+----------+-------------+-------------+--------+
| created_date   | DATE        | ✗        |             |             |        |
+----------------+-------------+----------+-------------+-------------+--------+

parser_car_options
------------------

Опции автомобиля

+----------------+-------------+----------+-------------+-------------+--------+
| Поле           | Тип         | Nullable | Primary Key | Foreign Key | Индекс |
+================+=============+==========+=============+=============+========+
| id             | INTEGER     | ✗        | ✓           |             |        |
+----------------+-------------+----------+-------------+-------------+--------+
| request_id     | VARCHAR(50) | ✗        |             |             | ✓      |
+----------------+-------------+----------+-------------+-------------+--------+
| vin            | VARCHAR(50) | ✗        |             |             | ✓      |
+----------------+-------------+----------+-------------+-------------+--------+
| zone_name      | VARCHAR(100)| ✗        |             |             |        |
+----------------+-------------+----------+-------------+-------------+--------+
| option_code    | VARCHAR(50) | ✗        |             |             |        |
+----------------+-------------+----------+-------------+-------------+--------+
| option_title   | TEXT        | ✗        |             |             |        |
+----------------+-------------+----------+-------------+-------------+--------+
| is_selected    | BOOLEAN     | ✗        |             |             |        |
+----------------+-------------+----------+-------------+-------------+--------+
| source_from    | VARCHAR(50) | ✗        |             |             |        |
+----------------+-------------+----------+-------------+-------------+--------+
| created_date   | DATE        | ✗        |             |             |        |
+----------------+-------------+----------+-------------+-------------+--------+

parser_schedule_settings
------------------------

Настройки расписания работы парсера

+----------------+-------------+----------+-------------+-------------+--------+
| Поле           | Тип         | Nullable | Primary Key | Foreign Key | Индекс |
+================+=============+==========+=============+=============+========+
| id             | INTEGER     | ✗        | ✓           |             |        |
+----------------+-------------+----------+-------------+-------------+--------+
| start_time     | VARCHAR(5)  | ✗        |             |             |        |
+----------------+-------------+----------+-------------+-------------+--------+
| end_time       | VARCHAR(5)  | ✗        |             |             |        |
+----------------+-------------+----------+-------------+-------------+--------+
| is_active      | BOOLEAN     | ✗        |             |             |        |
+----------------+-------------+----------+-------------+-------------+--------+
| created_at     | DATETIME    | ✗        |             |             |        |
+----------------+-------------+----------+-------------+-------------+--------+
| updated_at     | DATETIME    | ✗        |             |             |        |
+----------------+-------------+----------+-------------+-------------+--------+

users
-----

Пользователи системы

+----------------------+-------------+----------+-------------+-------------+--------+
| Поле                 | Тип         | Nullable | Primary Key | Foreign Key | Индекс |
+======================+=============+==========+=============+=============+========+
| id                   | INTEGER     | ✗        | ✓           |             |        |
+----------------------+-------------+----------+-------------+-------------+--------+
| username             | VARCHAR(50) | ✗        |             |             | ✓      |
+----------------------+-------------+----------+-------------+-------------+--------+
| email                | VARCHAR(100)| ✓        |             |             |        |
+----------------------+-------------+----------+-------------+-------------+--------+
| hashed_password      | VARCHAR(255)| ✗        |             |             |        |
+----------------------+-------------+----------+-------------+-------------+--------+
| role                 | VARCHAR(20) | ✗        |             |             |        |
+----------------------+-------------+----------+-------------+-------------+--------+
| is_active            | BOOLEAN     | ✗        |             |             |        |
+----------------------+-------------+----------+-------------+-------------+--------+
| last_login           | DATETIME    | ✓        |             |             |        |
+----------------------+-------------+----------+-------------+-------------+--------+
| failed_login_attempts| INTEGER     | ✗        |             |             |        |
+----------------------+-------------+----------+-------------+-------------+--------+
| locked_until         | DATETIME    | ✓        |             |             |        |
+----------------------+-------------+----------+-------------+-------------+--------+
| created_at           | DATETIME    | ✗        |             |             |        |
+----------------------+-------------+----------+-------------+-------------+--------+
| updated_at           | DATETIME    | ✗        |             |             |        |
+----------------------+-------------+----------+-------------+-------------+--------+

user_sessions
-------------

Сессии пользователей

+-------------+-------------+----------+-------------+-------------+--------+
| Поле        | Тип         | Nullable | Primary Key | Foreign Key | Индекс |
+=============+=============+==========+=============+=============+========+
| id          | INTEGER     | ✗        | ✓           |             |        |
+-------------+-------------+----------+-------------+-------------+--------+
| user_id     | INTEGER     | ✗        |             | ✓           |        |
+-------------+-------------+----------+-------------+-------------+--------+
| token_hash  | VARCHAR(255)| ✗        |             |             | ✓      |
+-------------+-------------+----------+-------------+-------------+--------+
| expires_at  | DATETIME    | ✗        |             |             |        |
+-------------+-------------+----------+-------------+-------------+--------+
| ip_address  | VARCHAR(45) | ✓        |             |             |        |
+-------------+-------------+----------+-------------+-------------+--------+
| user_agent  | TEXT        | ✓        |             |             |        |
+-------------+-------------+----------+-------------+-------------+--------+
| created_at  | DATETIME    | ✗        |             |             |        |
+-------------+-------------+----------+-------------+-------------+--------+

**Связи:**
- user_sessions.user_id → users.id

ER-диаграмма
============

.. code-block:: text

   +----------------+       +------------------+
   | users          |       | user_sessions    |
   +----------------+       +------------------+
   | id (PK)        |<------| user_id (FK)     |
   | username       |       | token_hash       |
   | email          |       | expires_at       |
   | hashed_password|       | ip_address       |
   | role           |       | user_agent       |
   | is_active      |       | created_at       |
   | last_login     |       +------------------+
   | failed_login_  |
   | attempts       |
   | locked_until   |
   | created_at     |
   | updated_at     |
   +----------------+

   +----------------------+       +------------------------+
   | parser_car_detail    |       | parser_car_options     |
   +----------------------+       +------------------------+
   | id (PK)              |       | id (PK)                |
   | request_id (INDEX)   |       | request_id (INDEX)     |
   | vin (INDEX)          |       | vin (INDEX)            |
   | group_zone           |       | zone_name              |
   | code                 |       | option_code            |
   | title                |       | option_title           |
   | source_from          |       | is_selected            |
   | created_date         |       | source_from            |
   +----------------------+       | created_date           |
                                   +------------------------+

   +---------------------------+       +------------------------+
   | parser_car_detail_group_  |       | parser_car_request_    |
   | zone                      |       | status                 |
   +---------------------------+       +------------------------+
   | id (PK)                  |       | id (PK)                |
   | request_id (INDEX)       |       | request_id (INDEX)     |
   | vin (INDEX)              |       | vin (INDEX)            |
   | type                     |       | vin_status             |
   | title                    |       | comment                |
   | source_from              |       | started_at             |
   | created_date             |       | completed_at           |
   +---------------------------+       | created_date           |
                                        +------------------------+

   +------------------------+
   | parser_schedule_       |
   | settings               |
   +------------------------+
   | id (PK)                |
   | start_time             |
   | end_time               |
   | is_active              |
   | created_at             |
   | updated_at             |
   +------------------------+ 